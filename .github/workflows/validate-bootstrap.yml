name: Validate Bootstrap Manifests

on:
  pull_request:
    branches:
      - main
    paths:
      - "bootstrap/**"
      - "argocd/**"
      - ".github/workflows/validate-bootstrap.yml"

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    name: Static Analysis

    outputs:
      has_changes: ${{ steps.changed-files.outputs.has_changes }}
      changed_files: ${{ steps.changed-files.outputs.changed_files }}

      yamllint_status: ${{ steps.yamllint.outputs.yamllint_status }}
      yamllint_summary: ${{ steps.yamllint.outputs.yamllint_summary }}
      yamllint_artifact: ${{ steps.yamllint.outputs.yamllint_artifact }}

      kubeconform_status: ${{ steps.kubeconform.outputs.kubeconform_status }}
      kubeconform_summary: ${{ steps.kubeconform.outputs.kubeconform_summary }}
      kubeconform_artifact: ${{ steps.kubeconform.outputs.kubeconform_artifact }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed YAML files (vs base branch)
        id: changed-files
        shell: bash
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          set -euo pipefail

          base="${BASE_REF:-main}"
          git fetch --no-tags --prune origin "+refs/heads/${base}:refs/remotes/origin/${base}"
          git rev-parse --verify "refs/remotes/origin/${base}" >/dev/null

          changed="$(
            git diff --name-only --diff-filter=ACMRT "origin/${base}...HEAD" -- \
              'bootstrap/**' \
              'argocd/**' \
            | grep -E '\.(ya?ml)$' \
            || true
          )"

          {
            echo "changed_files<<EOF"
            printf '%s\n' "$changed"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          if [ -z "$changed" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run yamllint on changed files
        id: yamllint
        if: steps.changed-files.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail

          changed_files="${{ steps.changed-files.outputs.changed_files }}"
          mapfile -t files <<<"$changed_files"

          files_to_lint=()
          for f in "${files[@]}"; do
            f="${f#"${f%%[![:space:]]*}"}"
            f="${f%"${f##*[![:space:]]}"}"
            [ -n "$f" ] && files_to_lint+=("$f")
          done

          if [ ${#files_to_lint[@]} -eq 0 ]; then
            echo "yamllint_status=SKIPPED" >> "$GITHUB_OUTPUT"
            {
              echo "yamllint_summary<<EOF"
              echo "No YAML files to lint."
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            echo "yamllint_artifact=" >> "$GITHUB_OUTPUT"
            echo "yamllint_log_path=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          log="$RUNNER_TEMP/yamllint.log"
          artifact="yamllint-log"

          set +e
          yamllint -f parsable -c .yamllint "${files_to_lint[@]}" >"$log" 2>&1
          rc=$?
          set -e

          errors_count="$(grep -c '\[error\]' "$log" || true)"
          warnings_count="$(grep -c '\[warning\]' "$log" || true)"

          status="PASSED"
          if [ "$errors_count" -gt 0 ]; then
            status="FAILED"
          elif [ "$warnings_count" -gt 0 ]; then
            status="WARNINGS"
          else
            [ "$rc" -ne 0 ] && status="FAILED"
          fi

          excerpt="$(sed -n '1,80p' "$log")"
          summary="Errors: ${errors_count}, Warnings: ${warnings_count}"
          if [ -n "$excerpt" ]; then
            summary="${summary}\n\n${excerpt}"
          fi

          echo "yamllint_status=$status" >> "$GITHUB_OUTPUT"
          {
            echo "yamllint_summary<<EOF"
            printf '%b\n' "$summary"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "yamllint_artifact=$artifact" >> "$GITHUB_OUTPUT"
          echo "yamllint_log_path=$log" >> "$GITHUB_OUTPUT"

          exit 0

      - name: Upload yamllint log
        if: steps.changed-files.outputs.has_changes == 'true' && (steps.yamllint.outputs.yamllint_status == 'FAILED' || steps.yamllint.outputs.yamllint_status == 'WARNINGS')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.yamllint.outputs.yamllint_artifact }}
          path: ${{ steps.yamllint.outputs.yamllint_log_path }}

      - name: Install kubeconform
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes schemas on changed files
        id: kubeconform
        if: steps.changed-files.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail

          changed_files="${{ steps.changed-files.outputs.changed_files }}"
          mapfile -t all_files <<<"$changed_files"

          files_to_validate=()
          for f in "${all_files[@]}"; do
            f="${f#"${f%%[![:space:]]*}"}"
            f="${f%"${f##*[![:space:]]}"}"
            [ -z "$f" ] && continue
            [[ "$f" == *kustomization.yaml ]] && continue
            files_to_validate+=("$f")
          done

          if [ ${#files_to_validate[@]} -eq 0 ]; then
            echo "kubeconform_status=SKIPPED" >> "$GITHUB_OUTPUT"
            {
              echo "kubeconform_summary<<EOF"
              echo "No YAML files (excluding kustomization.yaml) to validate."
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            echo "kubeconform_artifact=" >> "$GITHUB_OUTPUT"
            echo "kubeconform_log_path=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          log="$RUNNER_TEMP/kubeconform.log"
          artifact="kubeconform-log"
          : > "$log"

          failed=0

          set +e
          for file in "${files_to_validate[@]}"; do
            out="$(kubeconform -strict "$file" 2>&1)"
            rc=$?
            if [ $rc -ne 0 ]; then
              failed=1
              {
                echo "==> $file"
                printf '%s\n' "$out"
                echo
              } >> "$log"
            fi
          done
          set -e

          status=$([ $failed -eq 1 ] && echo "FAILED" || echo "PASSED")

          excerpt="$(sed -n '1,120p' "$log" || true)"
          if [ -z "${excerpt:-}" ]; then
            summary="No schema validation errors."
          else
            summary="Schema validation errors detected:\n\n${excerpt}"
          fi

          echo "kubeconform_status=$status" >> "$GITHUB_OUTPUT"
          {
            echo "kubeconform_summary<<EOF"
            printf '%b\n' "$summary"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "kubeconform_artifact=$artifact" >> "$GITHUB_OUTPUT"
          echo "kubeconform_log_path=$log" >> "$GITHUB_OUTPUT"

          exit 0

      - name: Upload kubeconform log
        if: steps.changed-files.outputs.has_changes == 'true' && steps.kubeconform.outputs.kubeconform_status == 'FAILED'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.kubeconform.outputs.kubeconform_artifact }}
          path: ${{ steps.kubeconform.outputs.kubeconform_log_path }}

  build-validation:
    runs-on: ubuntu-latest
    name: Build Validation
    needs: static-analysis

    outputs:
      kustomize_bootstrap_status: ${{ steps.kustomize-bootstrap.outputs.kustomize_status }}
      kustomize_bootstrap_summary: ${{ steps.kustomize-bootstrap.outputs.kustomize_summary }}
      kustomize_bootstrap_artifact: ${{ steps.kustomize-bootstrap.outputs.kustomize_artifact }}

      kustomize_argocd_status: ${{ steps.kustomize-argocd.outputs.kustomize_status }}
      kustomize_argocd_summary: ${{ steps.kustomize-argocd.outputs.kustomize_summary }}
      kustomize_argocd_artifact: ${{ steps.kustomize-argocd.outputs.kustomize_artifact }}

      kubelinter_status: ${{ steps.kube-linter.outputs.kubelinter_status }}
      kubelinter_summary: ${{ steps.kube-linter.outputs.kubelinter_summary }}
      kubelinter_artifact: ${{ steps.kube-linter.outputs.kubelinter_artifact }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Validate Kustomize build - bootstrap
        id: kustomize-bootstrap
        shell: bash
        run: |
          set -euo pipefail

          log="$RUNNER_TEMP/kustomize-bootstrap.log"
          artifact="kustomize-bootstrap-log"

          set +e
          kustomize build bootstrap/ > /dev/null 2>"$log"
          rc=$?
          set -e

          status=$([ $rc -eq 0 ] && echo "PASSED" || echo "FAILED")

          excerpt="$(tail -n 120 "$log" 2>/dev/null || true)"
          if [ -z "${excerpt:-}" ]; then
            summary="kustomize build bootstrap/ succeeded."
          else
            summary="${excerpt}"
          fi

          echo "kustomize_status=$status" >> "$GITHUB_OUTPUT"
          {
            echo "kustomize_summary<<EOF"
            printf '%s\n' "$summary"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "kustomize_artifact=$artifact" >> "$GITHUB_OUTPUT"
          echo "kustomize_log_path=$log" >> "$GITHUB_OUTPUT"

          exit 0

      - name: Upload kustomize bootstrap log
        if: steps.kustomize-bootstrap.outputs.kustomize_status == 'FAILED'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.kustomize-bootstrap.outputs.kustomize_artifact }}
          path: ${{ steps.kustomize-bootstrap.outputs.kustomize_log_path }}

      - name: Validate Kustomize build - argocd
        id: kustomize-argocd
        shell: bash
        run: |
          set -euo pipefail

          log="$RUNNER_TEMP/kustomize-argocd.log"
          artifact="kustomize-argocd-log"

          set +e
          kustomize build argocd/ > /dev/null 2>"$log"
          rc=$?
          set -e

          status=$([ $rc -eq 0 ] && echo "PASSED" || echo "FAILED")

          excerpt="$(tail -n 120 "$log" 2>/dev/null || true)"
          if [ -z "${excerpt:-}" ]; then
            summary="kustomize build argocd/ succeeded."
          else
            summary="${excerpt}"
          fi

          echo "kustomize_status=$status" >> "$GITHUB_OUTPUT"
          {
            echo "kustomize_summary<<EOF"
            printf '%s\n' "$summary"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "kustomize_artifact=$artifact" >> "$GITHUB_OUTPUT"
          echo "kustomize_log_path=$log" >> "$GITHUB_OUTPUT"

          exit 0

      - name: Upload kustomize argocd log
        if: steps.kustomize-argocd.outputs.kustomize_status == 'FAILED'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.kustomize-argocd.outputs.kustomize_artifact }}
          path: ${{ steps.kustomize-argocd.outputs.kustomize_log_path }}

      - name: Install kube-linter
        shell: bash
        run: |
          set -euo pipefail
          version="v0.8.1"
          download_url="https://github.com/stackrox/kube-linter/releases/download/${version}/kube-linter-linux.tar.gz"
          curl -fsSL -o /tmp/kube-linter.tar.gz "${download_url}"
          tar -C /tmp -xzf /tmp/kube-linter.tar.gz
          sudo mv /tmp/kube-linter /usr/local/bin/kube-linter
          sudo chmod +x /usr/local/bin/kube-linter
          kube-linter version

      - name: Run kube-linter on rendered manifests
        id: kube-linter
        shell: bash
        run: |
          set -euo pipefail

          bootstrap_out="$RUNNER_TEMP/rendered-bootstrap.yaml"
          argocd_out="$RUNNER_TEMP/rendered-argocd.yaml"

          set +e
          kustomize build bootstrap/ >"$bootstrap_out" 2>/dev/null
          rc1=$?
          kustomize build argocd/ >"$argocd_out" 2>/dev/null
          rc2=$?
          set -e

          if [ $rc1 -ne 0 ] || [ $rc2 -ne 0 ]; then
            echo "kubelinter_status=SKIPPED" >> "$GITHUB_OUTPUT"
            {
              echo "kubelinter_summary<<EOF"
              echo "Skipped: unable to render manifests because kustomize build failed (see kustomize logs)."
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            echo "kubelinter_artifact=" >> "$GITHUB_OUTPUT"
            echo "kubelinter_log_path=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # DEBUG START
          echo "Rendered manifest debug:"
          echo "bootstrap_out=$bootstrap_out"
          echo "argocd_out=$argocd_out"
          
          # File sizes
          ls -lh "$bootstrap_out" "$argocd_out" || true
          
          # Approx doc/object counts
          echo "bootstrap: kind lines = $(grep -c '^kind:' "$bootstrap_out" || true)"
          echo "argocd:    kind lines = $(grep -c '^kind:' "$argocd_out" || true)"
          echo "bootstrap: apiVersion lines = $(grep -c '^apiVersion:' "$bootstrap_out" || true)"
          echo "argocd:    apiVersion lines = $(grep -c '^apiVersion:' "$argocd_out" || true)"

          echo "DEBUG: Print rendered files"
          echo "# bootstrap"
          cat "$bootstrap_out" || true
          echo "# argocd"
          cat "$argocd_out" || true
          # DEBUG END
          
          log="$RUNNER_TEMP/kube-linter.log"
          artifact="kube-linter-log"

          set +e
          kube-linter lint "$bootstrap_out" "$argocd_out" >"$log" 2>&1
          rc=$?
          set -e

          # kube-linter exit codes:
          # 0 = no findings
          # 1 = findings
          # >1 = tool error
          status="PASSED"
          if [ $rc -eq 0 ]; then
            status="PASSED"
          else
            status="FAILED"
          fi

          excerpt="$(sed -n '1,120p' "$log" || true)"
          if [ -z "${excerpt:-}" ]; then
            summary="No kube-linter output."
          else
            summary="${excerpt}"
          fi

          echo "kubelinter_status=$status" >> "$GITHUB_OUTPUT"
          {
            echo "kubelinter_summary<<EOF"
            printf '%b\n' "$summary"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "kubelinter_artifact=$artifact" >> "$GITHUB_OUTPUT"
          echo "kubelinter_log_path=$log" >> "$GITHUB_OUTPUT"

          exit 0

      - name: Upload kube-linter log
        if: steps.kube-linter.outputs.kubelinter_status == 'FAILED'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.kube-linter.outputs.kubelinter_artifact }}
          path: ${{ steps.kube-linter.outputs.kubelinter_log_path }}

  deployment-readiness:
    runs-on: ubuntu-latest
    name: Deployment Readiness
    needs: build-validation

    outputs:
      crd_ordering_status: ${{ steps.crd-ordering.outputs.crd_ordering_status }}
      crd_ordering_summary: ${{ steps.crd-ordering.outputs.crd_ordering_summary }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate CRD ordering
        id: crd-ordering
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -d "bootstrap/crds/" ]; then
            echo "crd_ordering_status=FAILED" >> "$GITHUB_OUTPUT"
            {
              echo "crd_ordering_summary<<EOF"
              echo "Directory bootstrap/crds/ is missing."
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "crd_ordering_status=PASSED" >> "$GITHUB_OUTPUT"
          {
            echo "crd_ordering_summary<<EOF"
            echo "bootstrap/crds/ exists."
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          exit 0

  validation-summary:
    runs-on: ubuntu-latest
    name: Validation Summary
    needs: [static-analysis, build-validation, deployment-readiness]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Compute overall status (checks)
        id: overall
        shell: bash
        run: |
          set -euo pipefail

          fail=0
          warn=0

          consider() {
            s="${1:-SKIPPED}"
            if [ "$s" = "FAILED" ]; then
              fail=1
            elif [ "$s" = "WARNINGS" ]; then
              warn=1
            fi
          }

          consider "${{ needs.static-analysis.outputs.yamllint_status || 'SKIPPED' }}"
          consider "${{ needs.static-analysis.outputs.kubeconform_status || 'SKIPPED' }}"
          consider "${{ needs.build-validation.outputs.kustomize_bootstrap_status || 'SKIPPED' }}"
          consider "${{ needs.build-validation.outputs.kustomize_argocd_status || 'SKIPPED' }}"
          consider "${{ needs.build-validation.outputs.kubelinter_status || 'SKIPPED' }}"
          consider "${{ needs.deployment-readiness.outputs.crd_ordering_status || 'SKIPPED' }}"

          overall="PASSED"
          if [ "$fail" -eq 1 ]; then
            overall="FAILED"
          elif [ "$warn" -eq 1 ]; then
            overall="WARNINGS"
          fi

          echo "overall_checks=$overall" >> "$GITHUB_OUTPUT"

      - name: Generate app token
        id: app-token
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CI_APP_ID }}
          private-key: ${{ secrets.CI_APP_PRIVATE_KEY }}

      - name: Post validation summary to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            function badge(s) {
              if (s === "FAILED") return "❌ FAILED";
              if (s === "WARNINGS") return "⚠️ WARNINGS";
              if (s === "SKIPPED") return "➖ SKIPPED";
              return "✅ PASSED";
            }

            function runUrl() {
              return `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            }

            function section(title, st, summary, artifactName) {
              const s = (st || "SKIPPED").trim();
              const sum = (summary || "").trim();
              const artifactLine = artifactName && artifactName.trim()
                ? `\n\nFull output: artifact \`${artifactName}\` (see run ${runUrl()})`
                : `\n\nSee run logs: ${runUrl()}`;

              return `\n\n### ${title}\n- Result: ${badge(s)}\n` +
                (sum ? `\n\`\`\`\n${summary}\n\`\`\`\n` : `\n_No output._\n`) +
                artifactLine;
            }

            const overallChecks = `${{ steps.overall.outputs.overall_checks }}` || "SKIPPED";

            // FIX: avoid JS template-literal pitfalls by building with normal string concatenation
            let report = "# CI Pipeline Validation Report\n\n";
            report += "## Merge Status (computed from checks): " + badge(overallChecks) + "\n";
            report += "This matches whether the PR is merge-blocked by this workflow.\n";

            report += "\n### Layer 1: Static Analysis";
            report += section(
              "Yamllint (changed files)",
              `${{ needs.static-analysis.outputs.yamllint_status }}`,
              `${{ needs.static-analysis.outputs.yamllint_summary }}`,
              `${{ needs.static-analysis.outputs.yamllint_artifact }}`
            );
            report += section(
              "Kubeconform (changed files)",
              `${{ needs.static-analysis.outputs.kubeconform_status }}`,
              `${{ needs.static-analysis.outputs.kubeconform_summary }}`,
              `${{ needs.static-analysis.outputs.kubeconform_artifact }}`
            );

            report += "\n### Layer 2: Build & Integration";
            report += section(
              "Kustomize build (bootstrap/)",
              `${{ needs.build-validation.outputs.kustomize_bootstrap_status }}`,
              `${{ needs.build-validation.outputs.kustomize_bootstrap_summary }}`,
              `${{ needs.build-validation.outputs.kustomize_bootstrap_artifact }}`
            );
            report += section(
              "Kustomize build (argocd/)",
              `${{ needs.build-validation.outputs.kustomize_argocd_status }}`,
              `${{ needs.build-validation.outputs.kustomize_argocd_summary }}`,
              `${{ needs.build-validation.outputs.kustomize_argocd_artifact }}`
            );
            report += section(
              "kube-linter (rendered manifests)",
              `${{ needs.build-validation.outputs.kubelinter_status }}`,
              `${{ needs.build-validation.outputs.kubelinter_summary }}`,
              `${{ needs.build-validation.outputs.kubelinter_artifact }}`
            );

            report += "\n### Layer 3: Deployment Readiness";
            report += section(
              "CRD ordering",
              `${{ needs.deployment-readiness.outputs.crd_ordering_status }}`,
              `${{ needs.deployment-readiness.outputs.crd_ordering_summary }}`,
              ""
            );

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Check validation results
        shell: bash
        run: |
          set -euo pipefail

          fail=0

          [ "${{ needs.static-analysis.result }}" != "success" ] && fail=1
          [ "${{ needs.build-validation.result }}" != "success" ] && fail=1
          [ "${{ needs.deployment-readiness.result }}" != "success" ] && fail=1

          [ "${{ needs.static-analysis.outputs.yamllint_status || 'SKIPPED' }}" = "FAILED" ] && fail=1
          [ "${{ needs.static-analysis.outputs.kubeconform_status || 'SKIPPED' }}" = "FAILED" ] && fail=1
          [ "${{ needs.build-validation.outputs.kustomize_bootstrap_status || 'SKIPPED' }}" = "FAILED" ] && fail=1
          [ "${{ needs.build-validation.outputs.kustomize_argocd_status || 'SKIPPED' }}" = "FAILED" ] && fail=1
          [ "${{ needs.build-validation.outputs.kubelinter_status || 'SKIPPED' }}" = "FAILED" ] && fail=1
          [ "${{ needs.deployment-readiness.outputs.crd_ordering_status || 'SKIPPED' }}" = "FAILED" ] && fail=1

          if [ "$fail" -eq 1 ]; then
            exit 1
          fi
